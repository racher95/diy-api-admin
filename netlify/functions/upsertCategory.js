import { readJSON, writeJSON } from "./_shared.mjs";
export async function handler(event){try{if(event.httpMethod!=="POST")return{statusCode:405,body:"Method Not Allowed"};const {id,name,description="CategorÃ­a DIY",imgSrc="",productCount}=JSON.parse(event.body||"{}");if(!id||!name)return{statusCode:400,body:"id and name are required"};const cPath="cats/cat.json"; const cur=await readJSON(cPath); let cats=cur.json||[];const i=cats.findIndex(c=>c.id===id);const entry={id,name,description,imgSrc,productCount:productCount??(i>=0?(cats[i].productCount||0):0)};if(i>=0)cats[i]={...cats[i],...entry}; else cats.push(entry);await writeJSON(cPath,cats,cur.sha,`UPSERT category ${id}`);const cpPath=`cats_products/${id}.json`; const existing=await readJSON(cpPath);if(!existing.json)await writeJSON(cpPath,{catID:id,catName:name,products:[]},null,`CREATE cats_products ${id}`);return{statusCode:200,body:JSON.stringify({ok:true})};}catch(e){return{statusCode:500,body:String(e)}}}